---
title: "Delivery Linkage with Gravid/Parity"
author: "Dominick Lemas"
date: "01/05/2022"
output: html_document
---

```{r, include=FALSE}
##-------------- 
# **************************************************************************** #
# ***************                Project Overview              *************** #
# **************************************************************************** #
# Author:      Dominick Lemas
# Date:        January 05, 2022
# IRB:         IRB protocol IRB201601899  
#
# version: R 4.1.2 (2021-11-01)
# version: Rstudio 2021.09.1 Build 372  

# **************************************************************************** #
# ***************          Technical Notes                     *************** #
# **************************************************************************** #

# fuzzyjoin: https://community.rstudio.com/t/tidy-way-to-range-join-tables-on-an-interval-of-dates/7881

# **************************************************************************** #
# ***************                Objective                     *************** #
# **************************************************************************** #

# (1) link delivery and gravidity and parity data.

```

```{r, message=FALSE}
# **************************************************************************** #
# ***************                Library                       *************** #

library(tidyverse)
library(fuzzyjoin)

```

```{r, message=FALSE}

# load data

load("~/ehr-preeclampsia-model/data/processed/mom_gravid_raw.rda")
load("~/ehr-preeclampsia-model/data/processed/mombaby_delivery_raw.rda")

```


```{r, message=FALSE}

# format dates

delivery_final = delivery %>%
  mutate_at(vars(gest_start_date, part_dob, delivery_admit_date), as.Date, format = "%Y-%m-%d")

gravid_final = gravid %>%
  mutate_at(vars(pregnancy_start_date), as.Date, format = "%Y-%m-%d")

```

```{r, message=FALSE}

# join
start_time = Sys.time()

test=fuzzy_left_join(
  delivery_final,gravid_final,
  by = c(
    "mom_id" = "mom_id",
    "gest_start_date" = "pregnancy_start_date",
    "part_dob"="pregnancy_start_date"),
  match_fun = list(`==`, `>=`, `<=`)) 

end_time = Sys.time()
end_time - start_time

```
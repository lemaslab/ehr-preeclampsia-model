```{r}
# UF Baseline Time to Diagnosis 
library(dplyr)
library(readr)

load("C:/Users/haile/OneDrive/ehr-preeclampsia-model/data/processed/delivery_linked_v9.rda")
mom_comorbidities_icd10<-read_csv("C:/Users/haile/OneDrive/ehr-preeclampsia-model/data/raw/mom_comorbidities_list_ICD10_release.csv")

mom_comorbidities_icd9<-read_csv("C:/Users/haile/OneDrive/ehr-preeclampsia-model/data/raw/mom_comorbidities_list_ICD9_release.csv")
load("C:/Users/haile/OneDrive/ehr-preeclampsia-model/data/raw/mom_perinatal_raw.rda")
df=df%>%
  select(part_id, perinatal_dx_date, perinatal_dx_code, perinatal_dx_descrip, perinatal_dx_type)

maternal_release=read_csv("C:/Users/haile/OneDrive/ehr-preeclampsia-model/data/raw/maternal_release.csv")

names(df)[names(df)=="part_id"]<- "Deidentified_mom_ID"
names(df)[names(df)=="perinatal_dx_date"]<- "Diagnosis Start Date"
names(df)[names(df)=="perinatal_dx_code"]<- "Diagnosis Code"
names(df)[names(df)=="perinatal_dx_descrip"]<- "Diagnosis Description"
names(df)[names(df)=="perinatal_dx_type"]<- "Diagnosis Type"

#rename maternal release columns
names(maternal_release)[names(maternal_release)=="part_id"]<- "Deidentified_mom_ID"
names(maternal_release)[names(maternal_release)=="perinatal_dx_date"]<- "Diagnosis Start Date"
names(maternal_release)[names(maternal_release)=="perinatal_dx_code"]<- "Diagnosis Code"
names(maternal_release)[names(maternal_release)=="perinatal_dx_descrip"]<- "Diagnosis Description"
names(maternal_release)[names(maternal_release)=="perinatal_dx_type"]<- "Diagnosis Type"


```

#Time to Diagnosis
```{r}
delivery_final_v9$TimetoDiagnosis<-difftime(delivery_final_v9$perinatal_dx_date, delivery_final_v9$pregnancy_start_date, unit="days")

delivery_final_v9$TimetoDiagnosis<-gsub("days", "", delivery_final_v9$TimetoDiagnosis)
```

```{r}

mom_comorbidities_codes<-rbind(mom_comorbidities_icd10, mom_comorbidities_icd9, df, maternal_release)
mom_comorbidities_codes$Deidentified_mom_ID<-paste0("mom-", mom_comorbidities_codes$Deidentified_mom_ID)

mom_comorbidities_codes$`Diagnosis Start Date`<-as.factor(mom_comorbidities_codes$`Diagnosis Start Date`)
mom_comorbidities_codes$`Diagnosis Start Date`<-strptime(mom_comorbidities_codes$`Diagnosis Start Date`, format="%m/%d/%y")
mom_comorbidities_codes$`Diagnosis Start Date`<-as.Date(mom_comorbidities_codes$`Diagnosis Start Date`, format="%m-%d-%y")

names(mom_comorbidities_codes)[names(mom_comorbidities_codes)=="Deidentified_mom_ID"]<- "mom_id"

mom_codes=mom_comorbidities_codes%>%
  mutate(year=lubridate::year(`Diagnosis Start Date`))

mom_codes$mom_id<-paste(mom_codes$mom_id, mom_codes$year, sep = "_")

mom_visit2encounters=mom_codes%>%
  inner_join(delivery_final_v9)%>%
  filter(`Diagnosis Start Date` <= pregnancy_start_date+85 & `Diagnosis Start Date` <=pregnancy_start_date+112)
mom_visit2encounters=unique(mom_visit2encounters$mom_id)


mom_visit3encounters=mom_codes%>%
  inner_join(delivery_final_v9)%>%
  filter(`Diagnosis Start Date` <= pregnancy_start_date+113 & `Diagnosis Start Date` <=pregnancy_start_date+140)
mom_visit3encounters=unique(mom_visit3encounters$mom_id)
```

#Depression diagnosis
```{r}
df_depression=mom_comorbidities_codes%>%
  filter(grepl("F32|F33", mom_comorbidities_codes$`Diagnosis Code`))

#Add year of delivery to PART ID
df_depression=df_depression%>%
  mutate(year=lubridate::year(`Diagnosis Start Date`))

df_depression$mom_id<-paste(df_depression$mom_id, df_depression$year, sep = "_")

df_depression=df_depression%>%
  inner_join(delivery_final_v9, by = "mom_id")%>%
  filter(`Diagnosis Start Date` <= pregnancy_start_date+140)

moms_depression=unique(df_depression$mom_id)

#352-331-3502

delivery_final_v9$Depression<-ifelse(delivery_final_v9$mom_id %in% moms_depression, "1", "0")
```

#Sleep apnea diagnosis
```{r}
df_sleepapnea=mom_comorbidities_codes%>%
  filter(grepl("G47.3", mom_comorbidities_codes$`Diagnosis Code`))

#Add year of delivery to PART ID
df_sleepapnea=df_sleepapnea%>%
  mutate(year=lubridate::year(`Diagnosis Start Date`))

df_sleepapnea$mom_id<-paste(df_sleepapnea$mom_id, df_sleepapnea$year, sep = "_")

df_sleepapnea=df_sleepapnea%>%
  inner_join(delivery_final_v9, by = "mom_id")%>%
  filter(`Diagnosis Start Date` <= pregnancy_start_date+140)

moms_sleepapnea=unique(df_sleepapnea$mom_id)

delivery_final_v9$SleepApnea<-ifelse(delivery_final_v9$mom_id %in% moms_sleepapnea, "1", "0")
```

#Chronic Kidney Disease diagnosis
```{r}
df_kidneydisease=mom_comorbidities_codes%>%
  filter(grepl("N18", mom_comorbidities_codes$`Diagnosis Code`))

#Add year of delivery to PART ID
df_kidneydisease=df_kidneydisease%>%
  mutate(year=lubridate::year(`Diagnosis Start Date`))

df_kidneydisease$mom_id<-paste(df_kidneydisease$mom_id, df_kidneydisease$year, sep = "_")

df_kidneydisease=df_kidneydisease%>%
  inner_join(delivery_final_v9, by = "mom_id")%>%
  filter(`Diagnosis Start Date` <= pregnancy_start_date+140)

moms_kidneydisease=unique(df_kidneydisease$mom_id)

delivery_final_v9$KidneyDisease<-ifelse(delivery_final_v9$mom_id %in% moms_kidneydisease, "1", "0")
```

#Uncomplicated Diabetes Type II Disease diagnosis
```{r}
df_ucompdiabetesII=mom_comorbidities_codes%>%
  filter(grepl("E11.9", mom_comorbidities_codes$`Diagnosis Code`))

#Add year of delivery to PART ID
df_ucompdiabetesII=df_ucompdiabetesII%>%
  mutate(year=lubridate::year(`Diagnosis Start Date`))

df_ucompdiabetesII$mom_id<-paste(df_ucompdiabetesII$mom_id, df_ucompdiabetesII$year, sep = "_")

df_ucompdiabetesII=df_ucompdiabetesII%>%
  inner_join(delivery_final_v9, by = "mom_id")

moms_df_ucompdiabetesII=unique(df_ucompdiabetesII$mom_id)

delivery_final_v9$UncomplicatedDiabetesTypeII<-ifelse(delivery_final_v9$mom_id %in% moms_df_ucompdiabetesII, "1", "0")
```


#Uncomplicated Diabetes TypeI Disease diagnosis
```{r}
df_ucompdiabetesI=mom_comorbidities_codes%>%
  filter(grepl("E10.9", mom_comorbidities_codes$`Diagnosis Code`))

#Add year of delivery to PART ID
df_ucompdiabetesI=df_ucompdiabetesI%>%
  mutate(year=lubridate::year(`Diagnosis Start Date`))

df_ucompdiabetesI$mom_id<-paste(df_ucompdiabetesI$mom_id, df_ucompdiabetesI$year, sep = "_")

df_ucompdiabetesI=df_ucompdiabetesI%>%
  inner_join(delivery_final_v9, by = "mom_id")

moms_df_ucompdiabetesI=unique(df_ucompdiabetesI$mom_id)

delivery_final_v9$UncomplicatedDiabetesTypeI<-ifelse(delivery_final_v9$mom_id %in% moms_df_ucompdiabetesI, "1", "0")
```

#Unspecified Mood Or Anxiety Disorder diagnosis
```{r}
df_mood=mom_comorbidities_codes%>%
  filter(grepl("Mood|mood|Anxiety|anxiety", mom_comorbidities_codes$`Diagnosis Description`))

#Add year of delivery to PART ID
df_mood=df_mood%>%
  mutate(year=lubridate::year(`Diagnosis Start Date`))

df_mood$mom_id<-paste(df_mood$mom_id, df_mood$year, sep = "_")

df_mood=df_mood%>%
  inner_join(delivery_final_v9, by = "mom_id")%>%
  filter(`Diagnosis Start Date` <= pregnancy_start_date+140)

moms_mood=unique(df_mood$mom_id)

delivery_final_v9$MoodorAnxietyDisorder<-ifelse(delivery_final_v9$mom_id %in% moms_mood, "1", "0")
```

#Kidney Infection
```{r}
df_kidneyinfection=mom_comorbidities_codes%>%
  filter(grepl("O23.41", mom_comorbidities_codes$`Diagnosis Code`))

#Add year of delivery to PART ID
df_kidneyinfection=df_kidneyinfection%>%
  mutate(year=lubridate::year(`Diagnosis Start Date`))

df_kidneyinfection$mom_id<-paste(df_kidneyinfection$mom_id, df_kidneyinfection$year, sep = "_")

df_kidneyinfection=df_kidneyinfection%>%
  inner_join(delivery_final_v9, by = "mom_id")

df_kidneyinfection_moms=unique(df_kidneyinfection$mom_id)

delivery_final_v9$KidneyInfection<-ifelse(delivery_final_v9$mom_id %in% df_kidneyinfection_moms, "1", "0")
```

#Uncomplicated Hypertension
```{r}
df_uncomplicatedhypertension=mom_comorbidities_codes%>%
  filter(grepl("I15.9|I15.8", mom_comorbidities_codes$`Diagnosis Code`))

#Add year of delivery to PART ID
df_uncomplicatedhypertension=df_uncomplicatedhypertension%>%
  mutate(year=lubridate::year(`Diagnosis Start Date`))

df_uncomplicatedhypertension$mom_id<-paste(df_uncomplicatedhypertension$mom_id, df_uncomplicatedhypertension$year, sep = "_")

df_uncomplicatedhypertension=df_uncomplicatedhypertension%>%
  inner_join(delivery_final_v9, by = "mom_id")

df_uncomplicatedhypertension_moms=unique(df_uncomplicatedhypertension$mom_id)

delivery_final_v9$UncomplicatedHypertension<-ifelse(delivery_final_v9$mom_id %in% df_uncomplicatedhypertension_moms, "1", "0")
```
#Past PE Second Trimester   
```{r}
delivery_final_v9=delivery_final_v9%>%
  mutate(delivery_final_v9, mom_id=sapply(strsplit(delivery_final_v9$mom_id, split="_", fixed=TRUE), function(x) (x[1])))

PastPE_SecondTrimester=delivery_final_v9%>%
  filter(duplicated(delivery_final_v9$mom_id))

PastPE_SecondTrimester_moms=unique(PastPE_SecondTrimester$mom_id)

data_pastpe=delivery_final_v9%>%
  filter(delivery_final_v9$mom_id %in% PastPE_SecondTrimester_moms)%>%
  filter(past_pe == "0")%>%
  filter(grepl("second trimester", perinatal_dx_descrip))

past_pe_moms<-unique(data_pastpe$mom_id)

delivery_final_v9$PastPE_SecondTrimester<-ifelse(delivery_final_v9$mom_id %in% past_pe_moms, "1", "0")

delivery_final_v9$mom_id<-paste(delivery_final_v9$mom_id, delivery_final_v9$year, sep = "_")

```

#BMI Over 35
```{r}
df_bmi=mom_comorbidities_codes%>%
  filter(grepl("Z68.35|Z68.36|Z68.37|Z68.38|Z68.39|Z68.40|Z68.41|Z68.42|Z68.43|Z68.44|Z68.45", mom_comorbidities_codes$`Diagnosis Code`))

#Add year of delivery to PART ID
df_bmi=df_bmi%>%
  mutate(year=lubridate::year(`Diagnosis Start Date`))

df_bmi$mom_id<-paste(df_bmi$mom_id, df_bmi$year, sep = "_")

df_bmi=df_bmi%>%
  inner_join(delivery_final_v9, by = "mom_id")

df_bmi_moms=unique(df_bmi$mom_id)

delivery_final_v9$BMIOver35<-ifelse(delivery_final_v9$mom_id %in% df_bmi_moms, "1", "0")

```

#Systemic Lupus Erythematosus
```{r}
df_lupus=mom_comorbidities_codes%>%
  filter(grepl("M32", mom_comorbidities_codes$`Diagnosis Code`))

#Add year of delivery to PART ID
df_lupus=df_lupus%>%
  mutate(year=lubridate::year(`Diagnosis Start Date`))

df_lupus$mom_id<-paste(df_lupus$mom_id, df_lupus$year, sep = "_")

df_lupus=df_lupus%>%
  inner_join(delivery_final_v9, by = "mom_id")

df_lupus_moms=unique(df_lupus$mom_id)

delivery_final_v9$SystemicLupusErythematosus<-ifelse(delivery_final_v9$mom_id %in% df_lupus_moms, "1", "0")

```



```{r}

delivery_final_v9=delivery_final_v9%>%
  filter(!is.na(weeks)&!is.na(gravidity)&!is.na(parity))

#add column for multiple gestation
delivery_final_v9=delivery_final_v9%>%
  mutate(multiple_gestation=case_when(
    multgest_dx_subcategory == "twin" ~ "2",
    multgest_dx_subcategory == "triplet" ~ "3",
    multgest_dx_subcategory == "quadruplet" ~ "4",
    multgest_dx_subcategory == "multiple" ~ "1",
  ))

delivery_final_v9$multiple_gestation[is.na(delivery_final_v9$multiple_gestation)] <- 1

names(delivery_final_v9)[names(delivery_final_v9)=="multiple_gestation"]<- "NUMBER_OF_FETUSES"


delivery_final_v9=delivery_final_v9%>%
  filter(TimetoDiagnosis > 140)

delivery_final_v9$gravidity<-as.numeric(delivery_final_v9$gravidity)
delivery_final_v9$parity<-as.numeric(delivery_final_v9$parity)
delivery_final_v9$NUMBER_OF_FETUSES<-as.numeric(delivery_final_v9$NUMBER_OF_FETUSES)
#scale numeric variables
num_var = c("gravidity", "parity", "NUMBER_OF_FETUSES")
for(i in c(1:ncol(delivery_final_v9))){
  if(colnames(delivery_final_v9)[i]%in%num_var){
    delivery_final_v9[,i] = scale(delivery_final_v9[,i], center = F)
  }
}

#log-transform all skewed numeric variables
for(i in c(1:ncol(delivery_final_v9))){
  if(colnames(delivery_final_v9)[i]%in%num_var){
    delivery_final_v9[,i] = log(delivery_final_v9[,i]+1)
  }
}
timetodiagnosis_v1=delivery_final_v9


```

```{r}


# file name
file_name="timetodiagnosis_v1.rda"
data_export_directory=paste0("C:/Users/haile/OneDrive/Michigan/ehr-preeclampsia-model/data/processed/") 
data_export_path=paste0(data_export_directory,file_name)
timetodiagnosis_v1 %>% save(timetodiagnosis_v1, file=data_export_path)


```